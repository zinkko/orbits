<!DOCTYPE html>
<html>
    <meta charset="utf8">
    <title>2d orbit animation</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
    <body>
        <h1>Orbits!</h1>
        <canvas id="canvas" width="800" height="450"></canvas>
    </body>
    <script>
        const TAU = 2 * Math.PI;
        const epsilon = 0.0001;
        const W = 800;
        const H = 450;

        /**
         * Calculate ellipse parameters for the orbit. Orbit is centered around the main body at the center of the screen
         * 
         * @param a semi-major axis
         * @param e eccentricity
         * @param tilt tilt of the orbit center line
         */
        const createOrbit = (a, e, tilt) => {
            const fx = W/2;
            const fy = H/2;

            const c = e*a;
            const factor = Math.sqrt((1+e) / (1-e));
            return {
                a,
                b: Math.sqrt(a*a - c*c),
                c,
                e,
                fx,
                fy,
                cx: fx - c * Math.cos(tilt),
                cy: fy - c * Math.sin(tilt),
                tilt,
                getR: (theta) => {
                   const numerator = 1 - e*e;
                   const denominator = 1 + e*Math.cos(theta);
                   return a * numerator / denominator;
                },
                calculateEccentricAnomaly: (M) => {
                    let estimate = M;
                    for (let i=0; i<10; i++) {
                        let old = estimate;
                        estimate = estimate - (M + e * Math.sin(estimate) - estimate) / (e * Math.cos(estimate) - 1);
                        if (Math.abs(estimate - old) < epsilon) {
                            break;
                        }
                    }
                    return estimate % TAU;
                },
                calculateTrueAnomaly: (E) => {
                    return 2 * Math.atan(factor * Math.tan(E/2));
                    // const y = Math.sqrt(1 - e*e) * Math.sin(E);
                    // const x = Math.cos(E) - e;
                    // return Math.atan2(y, x);
                },
            }
        }

        const o1 = createOrbit(120, 0.5, Math.PI/6);
        const o2 = createOrbit(140, 0.7, 0.1);

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');


        const draw = (M1, M2) => {
            ctx.clearRect(0, 0, W, H);
            ctx.beginPath();
            ctx.fillStyle = 'darkorange';
            ctx.arc(W/2, H/2, 16, 0, TAU);
            ctx.fill();
            ctx.closePath();
            
            drawOrbit(M1, o1);
            drawOrbit(M2, o2);
        }

        const drawOrbit = (M, orbit) => {
            const E = o1.calculateEccentricAnomaly(M);
            const nu = o1.calculateTrueAnomaly(E);

            ctx.beginPath();
            ctx.ellipse(orbit.cx, orbit.cy, orbit.a, orbit.b, orbit.tilt, 0, TAU);
            ctx.stroke();
            ctx.closePath();
            
            ctx.beginPath();
            ctx.fillStyle = 'black';
            const r = orbit.getR(nu);
            ctx.arc(orbit.fx + r * Math.cos(orbit.tilt + nu), orbit.fy + r * Math.sin(orbit.tilt + nu), 4, 0, TAU);
            ctx.fill();
            ctx.closePath();
        }

        let M = 0;
        const startAnimation = () => {
            const step = () => {
                draw(M, M);
                M += 0.02;
                window.requestAnimationFrame(step);
            }
            window.requestAnimationFrame(step);
        }

        startAnimation();
    </script>
</html>
